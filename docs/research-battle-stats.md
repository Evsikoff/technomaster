# Исследование: Расчёт боя между картами на основе статов

## Контекст

Technomaster — браузерная карточная игра с пошаговыми боями на поле 4×4. Игрок и ИИ по очереди выкладывают карты на поле, после чего происходят захваты и бои. Основная логика боя находится в файле `js/party-game-orchestrator.js`.

---

## 1. Статы карты

Каждая карта имеет следующие боевые характеристики:

| Стат | Описание |
|------|----------|
| `attackLevel` | Сила атаки (0–15, хранится как hex/int) |
| `attackType` | Тип атаки: `P` (физ.), `E`/`M` (электр.), `X` (смешанный), `A` (абсолютный) |
| `mechanicalDefense` | Защита от физических атак |
| `electricalDefense` | Защита от электрических атак |
| `cardLevel` | Уровень карты (0–2) |
| `arrowTopLeft`...`arrowLeft` | 8 стрелок-направлений (boolean) |

### Конвертация значений статов (`getStatValue()`)

```
Вход → Выход:
  целое 0–15  → value * 16  (например, 5 → 80, 15 → 240)
  hex строка  → parseInt(hex)
  дробное     → как есть
```

---

## 2. Механика хода

**Файл:** `js/party-game-orchestrator.js`

1. Игрок/ИИ выкладывает карту на свободную клетку поля
2. Система проверяет 8 соседних клеток (`analyzeNeighbors()`)
3. Для каждого соседа-врага определяется тип конфликта:
   - **Захват (Capture):** у атакующей карты есть стрелка в направлении врага, у врага НЕТ стрелки назад → мгновенный захват без броска
   - **Бой (Battle):** у обеих карт есть встречные стрелки → бросок кубиков

---

## 3. Формула расчёта боя

### 3.1 Определение защиты (`resolveDefenseValue()`)

Эффективная защита зависит от `attackType` атакующего:

| attackType | Формула защиты |
|------------|---------------|
| `P` (физ.) | `mechanicalDefense` |
| `E` или `M` (электр.) | `electricalDefense` |
| `X` (смешанный) | `min(mechanicalDefense, electricalDefense)` |
| `A` (абсолютный) | `min(mechanicalDefense, electricalDefense, attackLevel_защитника)` |

### 3.2 Бросок кубиков (`executeBattle()`)

```javascript
attackValue  = getStatValue(attacker.attackLevel)    // например, 15 → 240
defenseValue = resolveDefenseValue(attacker, defender) // зависит от типа атаки

attackRoll  = Math.floor(Math.random() * Math.max(1, attackValue))   // 0..attackValue-1
defenseRoll = Math.floor(Math.random() * Math.max(1, defenseValue))  // 0..defenseValue-1

attackerWins = (attackRoll >= defenseRoll)
```

### 3.3 Результат боя

- **Атакующий побеждает** (`attackRoll >= defenseRoll`): карта защитника переходит атакующему
- **Защитник побеждает** (`defenseRoll > attackRoll`): карта атакующего переходит защитнику

---

## 4. Комбо-цепочка (`processComboChain()`)

После успешного боя или захвата:

1. Для каждой только что захваченной карты проверяются 8 направлений
2. Если у захваченной карты есть стрелка в направлении вражеской карты — вражеская карта захватывается (стрелка врага НЕ нужна)
3. Процесс повторяется рекурсивно, пока есть новые захваты

**Важно:** если атакующий **проиграл** бой — комбо и мгновенные захваты НЕ срабатывают.

---

## 5. Вероятность победы (для ИИ)

**Файл:** `js/ai-move-calculator.js`

```javascript
ratio = attackValue / (attackValue + defenseValue)
winChance = Math.max(0, Math.min(1, ratio))
```

Пример: атака 240 vs защита 80 → `240 / 320 = 0.75` (75% шанс победы)

---

## 6. Оценка силы карты (для автоподбора руки)

**Файл:** `js/auto-hand-collector.js`

```
powerScore = (attackLevel * 1.5) + mechanicalDefense + electricalDefense + typeBonus

typeBonus:
  'A' (абсолютный) → +15
  'X' (смешанный)  → +12
  'P', 'E'         → 0
```

---

## 7. Прокачка карт после боя

**Константы:** `LEVEL_UP_CHANCE = 0.1`, `MAX_CARD_LEVEL = 2`

- Каждая использованная в бою карта игрока имеет 10% шанс повысить уровень
- При повышении уровня статы перегенерируются из БД (`card_levels`) с новыми диапазонами `power_min/max`, `reliability_min/max`, `shielding_min/max`

---

## 8. Условия победы в матче

- Игра заканчивается, когда нет свободных клеток или у обоих закончились карты
- Побеждает тот, у кого больше карт на поле
- Победитель крадёт карту у проигравшего

---

## Ключевые файлы

| Файл | Назначение |
|------|-----------|
| `js/party-game-orchestrator.js` | Ядро боевой системы, формулы, комбо |
| `js/ai-move-calculator.js` | ИИ: оценка ходов и вероятности победы |
| `js/ai-attack-selector.js` | ИИ: выбор цели при множественных боях |
| `js/auto-hand-collector.js` | Автоподбор руки, скоринг карт |
| `js/card-renderer.js` | Загрузка карт из БД, генерация статов |
| `public/data/cards.db` | SQLite БД с определениями карт |
